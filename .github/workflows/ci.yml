name: Python Code Quality - Fixed & Safe

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  code-quality:
    name: โ Check & Auto-Fix
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install tools
      run: |
        pip install black autoflake isort flake8

    - name: ๐ง Check code quality
      id: code_check
      run: |
        echo "=== ุงูุชุญูู ูู ุฌูุฏุฉ ุงูููุฏ ==="
        
        # ูุญุต ูุง ุฅุฐุง ููุงู ุฃุฎุทุงุก
        if black --check --line-length 127 . ; then
          echo "โ ุงูููุฏ ููุณู ุจุดูู ุตุญูุญ"
          echo "needs_fix=false" >> $GITHUB_OUTPUT
        else
          echo "โ๏ธ ูุญุชุงุฌ ุงูููุฏ ุฅูู ุชูุณูู"
          echo "needs_fix=true" >> $GITHUB_OUTPUT
        fi

    - name: ๐ง Auto-fix formatting
      if: steps.code_check.outputs.needs_fix == 'true'
      run: |
        echo "=== ุงูุฅุตูุงุญ ุงูุชููุงุฆู ==="
        
        # ุงูุฅุตูุงุญ ุงูุชููุงุฆู
        autoflake --in-place --remove-unused-variables --remove-all-unused-imports --recursive .
        black --line-length 127 .
        isort .
        
        # ุฅุตูุงุญ ููุงูุฉ ุงููููุงุช
        find . -name "*.py" -exec sed -i -e '$a\' {} \;
        
        echo "โ ุชู ุงูุฅุตูุงุญ ุงูุชููุงุฆู"

    - name: ๐ Show fixed files
      if: steps.code_check.outputs.needs_fix == 'true'
      run: |
        echo "=== ุงููููุงุช ุงูุชู ุชู ุฅุตูุงุญูุง ==="
        git diff --name-only || echo "--- ูุงุฆูุฉ ุงููููุงุช ุงููุญุณูุฉ ---"
        echo ""
        echo "๐ ูุชูููุฐ ูุฐู ุงูุฅุตูุงุญุงุช ุนูู ุฌูุงุฒู ุงููุญูู:"
        echo "1. ุงูุณุฎ ุงูุฃูุงูุฑ ุงูุชุงููุฉ:"
        echo "   pip install black autoflake isort"
        echo "   black --line-length 127 ."
        echo "   autoflake --in-place --remove-unused-variables --recursive ."
        echo "   isort ."
        echo "2. ุดุบููุง ูู ูุฌูุฏ ูุดุฑูุนู"
        echo "3. git add . && git commit -m 'ุฅุตูุงุญ ุชููุงุฆู' && git push"

    - name: โ Run basic tests
      run: |
        echo "=== ุงุฎุชุจุงุฑ ุงูุชุดุบูู ==="
        python -c "
        print('๐ Python ูุนูู ุจูุฌุงุญ!')
        print('โ ุงูุฑูุงุถูุงุช ุงูุฃุณุงุณูุฉ: 1 + 1 =', 1 + 1)
        assert 1 + 1 == 2, 'ุงูุฑูุงุถูุงุช ุงูุฃุณุงุณูุฉ ูุนุทูุฉ!'
        
        # ุงุฎุชุจุงุฑ ุงูุงุณุชูุฑุงุฏ
        try:
            import os, sys
            print('โ ุงุณุชูุฑุงุฏ ุงูููุชุจุงุช ูุนูู')
        except Exception as e:
            print(f'โ ุฎุทุฃ ูู ุงูุงุณุชูุฑุงุฏ: {e}')
            raise
        print('๐ ูู ุงูุงุฎุชุจุงุฑุงุช ูุฌุญุช!')
        "

    - name: ๐ Final report
      run: |
        echo "๐ ุชูุฑูุฑ ููุงุฆู:"
        echo "โ ูุญุต ุงูุฌูุฏุฉ ุงูุชูู"
        echo "โ ุงูุงุฎุชุจุงุฑุงุช ุงูุฃุณุงุณูุฉ ูุฌุญุช"
        if [ "${{ steps.code_check.outputs.needs_fix }}" = "true" ]; then
          echo "โ๏ธ ุชู ุงูุชุดุงู ูุดุงูู ุชูุณูู - ุงูุธุฑ ุฃุนูุงู ููุญู"
        else
          echo "๐ ุงูููุฏ ูุซุงูู!"
        fi
